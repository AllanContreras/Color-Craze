# Azure DevOps CI pipeline for Color-Craze
# - Backend: Maven build + tests with JaCoCo coverage
# - Frontend: Node + Vite build and optional Vitest coverage
# - SonarCloud analysis (optional via variables)

trigger:
  branches:
    include:
      - main
      - chore/*
      - feature/*
      - bugfix/*
      - chore/sonarcloud-verify

pr:
  branches:
    include:
      - '*'

pool:
  name: 'Default'  # Volver a agente self-hosted debido a falta de parallelism hospedado

variables:
  # SonarCloud variables (set these in pipeline variables or a variable group)
  SONAR_ORG: '$(SONARCLOUD_ORG)'
  SONAR_PROJECT_KEY: '$(SONARCLOUD_PROJECTKEY)'
  SONAR_PROJECT_NAME: 'Color-Craze'
  SONAR_TOKEN: '$(SONARCLOUD_TOKEN)'
  MAVEN_OPTS: "-Xmx1024m"

stages:
  - stage: Build_and_Test
    displayName: Build, Test, Analyze
    jobs:
      - job: Backend
        displayName: Backend (Maven)
        steps:
          - checkout: self
          # Asumimos JDK 17 ya instalado en el agente self-hosted (Windows). Opcional instalar manualmente.

          - task: Cache@2
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: 'maven | "$(Agent.OS)"'
              path: '$(USERPROFILE)/.m2/repository'

          - powershell: |
              Write-Host "Usando Maven Wrapper"
              Get-ChildItem . -Force | Where-Object { $_.Name -like 'mvnw*' } | Format-Table Name
              .\mvnw.cmd -version
              .\mvnw.cmd -B -DskipTests=false clean verify
            displayName: 'Maven build & tests'

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/*.xml'
              searchFolder: '$(System.DefaultWorkingDirectory)'
              mergeTestResults: true
            displayName: 'Publicar resultados de tests (backend)'

          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: 'JaCoCo'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/target/site/jacoco/jacoco.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/**/target/site/jacoco'
            displayName: 'Publicar cobertura (JaCoCo)'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/target/site/jacoco'
              artifact: 'backend-coverage'
              publishLocation: 'pipeline'
            displayName: 'Publicar artefacto cobertura backend (JaCoCo)'

      - job: Frontend
        displayName: Frontend (Node + Vite)
        steps:
          - checkout: self
          # Asumimos Node 18.x instalado en el agente self-hosted.

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | **/frontend/package-lock.json'
              restoreKeys: 'npm | "$(Agent.OS)"'
              path: '$(System.DefaultWorkingDirectory)/frontend/node_modules'

          - powershell: |
              Set-Location frontend
              if (Test-Path package-lock.json) {
                Write-Host "Encontrado package-lock.json; usando npm ci"
                npm ci
                if (!$?) {
                  Write-Warning "npm ci falló; intentando npm install"
                  npm install --no-fund --no-audit
                }
              } else {
                Write-Host "Sin package-lock.json; usando npm install"
                npm install --no-fund --no-audit
              }
              npm run build
            displayName: 'Vite build'

          - powershell: |
              Set-Location frontend
              if (Test-Path package-lock.json) {
                Write-Host "Encontrado package-lock.json; usando npm ci"
                npm ci
                if (!$?) {
                  Write-Warning "npm ci falló; intentando npm install"
                  npm install --no-fund --no-audit
                }
              } else {
                Write-Host "Sin package-lock.json; usando npm install"
                npm install --no-fund --no-audit
              }
              try {
                npm test
              } catch {
                Write-Warning "Tests frontend fallaron; continuando como opcional"
              }
              # Publicar cobertura lcov si existe
              $lcovPath = "$(System.DefaultWorkingDirectory)\frontend\coverage\lcov.info"
              if (Test-Path $lcovPath) {
                Write-Host "Encontrado coverage lcov; subiendo como Artifact"
                Write-Host "##vso[task.uploadfile]$lcovPath"
              } else {
                Write-Host "No se encontró coverage/lcov.info"
              }
            displayName: 'Tests frontend (Vitest)'

          - task: PublishCodeCoverageResults@1
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/frontend/coverage/cobertura-coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/frontend/coverage'
            displayName: 'Publicar cobertura frontend (Cobertura)'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/frontend/coverage'
              artifact: 'frontend-coverage'
              publishLocation: 'pipeline'
            displayName: 'Publicar artefacto cobertura frontend (HTML & lcov)'

      - job: Analyze
        displayName: SonarCloud Analyze (merge coverage)
        dependsOn:
          - Backend
          - Frontend
        steps:
          - checkout: self
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: 'backend-coverage'
              path: '$(System.DefaultWorkingDirectory)/.artifacts/backend-coverage'
            displayName: 'Descargar cobertura backend'

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: 'frontend-coverage'
              path: '$(System.DefaultWorkingDirectory)/.artifacts/frontend-coverage'
            displayName: 'Descargar cobertura frontend'
          - powershell: |
              Write-Host "== SonarCloud fallback (no tasks installed) =="
              # Usar SONAR_TOKEN ya definido en variables del pipeline
              if (-not $env:SONAR_TOKEN) { Write-Error "Falta SONAR_TOKEN"; exit 1 }
              $jacocoItem = Get-ChildItem "$(System.DefaultWorkingDirectory)/.artifacts/backend-coverage" -Recurse -Filter jacoco.xml | Select-Object -First 1
              $lcovItem = Get-ChildItem "$(System.DefaultWorkingDirectory)/.artifacts/frontend-coverage" -Recurse -Filter lcov.info | Select-Object -First 1
              if (-not $jacocoItem) { Write-Warning "No se encontró jacoco.xml" }
              if (-not $lcovItem) { Write-Warning "No se encontró lcov.info" }

              $args = @(
                '-B','sonar:sonar',
                "-Dsonar.organization=$env:SONAR_ORG",
                "-Dsonar.projectKey=$env:SONAR_PROJECT_KEY",
                "-Dsonar.projectName=$env:SONAR_PROJECT_NAME",
                '-Dsonar.host.url=https://sonarcloud.io',
                "-Dsonar.projectVersion=$(Build.BuildNumber)",
                "-Dsonar.tests=src/test/java,frontend/src",
                "-Dsonar.test.inclusions=src/test/java/**/*Test.java,frontend/src/**/*.{test,spec}.{js,jsx,ts,tsx}",
                "-Dsonar.exclusions=**/node_modules/**,**/target/**,frontend/coverage/**",
                "-Dsonar.login=$env:SONAR_TOKEN"
              )

              if ($jacocoItem) {
                $args += "-Dsonar.coverage.jacoco.xmlReportPaths=$($jacocoItem.FullName)"
              }
              if ($lcovItem) {
                $args += "-Dsonar.javascript.lcov.reportPaths=$($lcovItem.FullName)"
              }

              Write-Host "Ejecutando: mvnw $($args -join ' ')"
              & .\mvnw.cmd $args
            displayName: 'SonarCloud (mvn sonar:sonar fallback)'
